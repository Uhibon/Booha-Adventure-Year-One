<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Booha Maze — Alignment Helper + Game</title>
<style>
:root{ --zoom:1; --tx:0px; --ty:0px; }
*{box-sizing:border-box;margin:0;padding:0}
html,body{width:100%;height:100%;overflow:hidden;}
/* Foresty page background (to match maze trees, not navy) */
body{background:radial-gradient(140% 100% at 50% 0%, #17381f 0%, #112a18 40%, #0c2012 85%, #08160c 100%); color:#eaf1ff; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",Helvetica,Arial}

/* Viewport & world (fullscreen) */
.viewport{position:relative;width:100vw;height:100vh;overflow:hidden;}
.world{position:absolute;left:50%;top:50%;transform:translate(calc(-50% + var(--tx)), calc(-50% + var(--ty))) scale(var(--zoom));transform-origin:center;transition:transform .5s ease;}

/* Maze background fills screen but keeps aspect */
#maze{width:100vw;height:100vh;background:url('assets/maze.png') center/contain no-repeat;}

/* Booha sprite (no box) */
#booha{position:absolute;width:68px;height:68px;transform:translate(-50%,-50%);z-index:10;pointer-events:none;filter:drop-shadow(0 0 10px #ffd400a6)}

/* Weekly stops */
.stop{position:absolute;width:20px;height:20px;border-radius:50%;transform:translate(-50%,-50%);cursor:pointer;opacity:.95;background:radial-gradient(circle,#29365d 0%, #1c2847 65%, #17223e 100%);box-shadow:0 0 0 2px #0008 inset}
.stop.active{background:radial-gradient(circle,#c7fbff 0%, #65e7ff 60%, #2bd0ff 100%);box-shadow:0 0 0 2px #00141e inset,0 0 14px #65e7ffbb,0 0 30px #2bd0ff55}

/* Edit mode helpers */
.tools{position:fixed;left:12px;bottom:12px;display:flex;gap:8px;z-index:100}
.btn{padding:10px 14px;font-weight:700;border-radius:12px;border:1px solid #ffffff26;background:#203a27;color:#e5edff;cursor:pointer}
.btn:hover{background:#25452f}
.editing .stop{outline:1px dashed #7dd3fc}
.coord{position:absolute;transform:translate(-50%,-120%);background:#0b1530; color:#cfe0ff; font-size:11px; padding:2px 6px; border-radius:8px; border:1px solid #ffffff22; display:none}
.index{position:absolute; transform:translate(-50%, -50%); color:#fff; font: 700 10px/1 system-ui; text-shadow:0 1px 2px #000; pointer-events:none; display:none}
.editing .coord, .editing .index{display:block}

/* Sparkle trail */
.spark{position:absolute;width:6px;height:6px;border-radius:50%;pointer-events:none;background:radial-gradient(circle at 35% 35%, #fff, #ffe66d 60%, transparent 72%);box-shadow:0 0 10px currentColor;animation:spark .7s ease-out forwards}
@keyframes spark{0%{transform:scale(.85);opacity:1}60%{transform:scale(1.1)}100%{transform:scale(.2) translateY(6px);opacity:0}}

/* Simple modal */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#0008;z-index:120}
.modal.show{display:flex}
.card{background:#101d42;padding:20px;border-radius:16px;width:min(680px,92vw);text-align:center;color:#fff;border:1px solid #ffffff22;box-shadow:0 20px 50px #000a}
.card a{display:inline-block;margin:0 8px;padding:10px 12px;border-radius:12px;border:1px solid #ffffff26;color:#e2e8f0;text-decoration:none;background:#101a39}
.card a:hover{background:#122045}
</style>
</head>
<body>
<div class="viewport" id="viewport">
  <div class="world" id="world">
    <div id="maze"></div>
  </div>
</div>
<img id="booha" src="assets/mazebooha.png" alt="booha" />

<!-- Tools -->
<div class="tools">
  <button class="btn" id="edit">EDIT</button>
  <button class="btn" id="copy">Copy JSON</button>
  <button class="btn" id="reset">Reset Progress</button>
</div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="card">
    <h2 id="title">Month — Week</h2>
    <p>Choose a deck to open.</p>
    <a id="deck1" href="#">Deck 1</a>
    <a id="deck2" href="#">Deck 2</a>
  </div>
</div>

<script>
// ----------------- CONFIG -----------------
const MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];
const MONTH_COLORS=['#cddfff','#ffb6c1','#ffda8a','#a7f5b1','#7fdfff','#ffe066','#ff9edb','#f8b54c','#d6b3ff','#ff9851','#ffd6a1','#fff4c7'];
const TOTAL=48;
const LS_POS='booha_maze_pos_v3';
const LS_INDEX='booha_maze_idx_v3';
const LS_DONE='booha_maze_done_v3';

let POS = JSON.parse(localStorage.getItem(LS_POS) || 'null');
let currentIndex = parseInt(localStorage.getItem(LS_INDEX) || '0',10);
let done = JSON.parse(localStorage.getItem(LS_DONE) || '[]');

// Initial path-based positions (follow your straight/turn maze from TL to BR)
if(!Array.isArray(POS) || POS.length!==TOTAL){
  const WAYPOINTS=[
    {x:3,y:2},{x:20,y:2},{x:20,y:10},{x:8,y:10},{x:8,y:18},{x:40,y:18},{x:40,y:6},{x:60,y:6},{x:60,y:14},{x:48,y:14},{x:48,y:26},{x:90,y:26},
    {x:90,y:50},{x:10,y:50},{x:10,y:64},{x:78,y:64},{x:78,y:72},{x:20,y:72},{x:20,y:84},{x:86,y:84},{x:86,y:92},{x:36,y:92},{x:36,y:98},{x:97,y:98}
  ];
  POS = interpolateStops(WAYPOINTS, TOTAL);
}

function interpolateStops(pts, n){
  let lens=[0]; for(let i=1;i<pts.length;i++){const a=pts[i-1],b=pts[i]; lens[i]=lens[i-1]+Math.hypot(b.x-a.x,b.y-a.y);} const total=lens[lens.length-1];
  const out=[]; for(let k=0;k<n;k++){ const d=(total*(k+1))/(n+1); let s=0; while(lens[s+1]<d) s++; const a=pts[s], b=pts[s+1]; const t=(d-lens[s])/(lens[s+1]-lens[s]); out.push({x:a.x+(b.x-a.x)*t,y:a.y+(b.y-a.y)*t}); } return out;
}

const world=document.getElementById('world');
const maze=document.getElementById('maze');
const booha=document.getElementById('booha');
const editBtn=document.getElementById('edit');
const copyBtn=document.getElementById('copy');
const resetBtn=document.getElementById('reset');
const modal=document.getElementById('modal');
const titleEl=document.getElementById('title');
const deck1=document.getElementById('deck1');
const deck2=document.getElementById('deck2');

const stops=[];
POS.forEach((p,i)=>{
  const el=document.createElement('div'); el.className='stop'; el.style.left=p.x+'%'; el.style.top=p.y+'%';
  const badge=document.createElement('span'); badge.className='index'; badge.textContent=i+1; el.appendChild(badge);
  const coord=document.createElement('span'); coord.className='coord'; coord.textContent=`${p.x.toFixed(1)}%, ${p.y.toFixed(1)}%`; el.appendChild(coord);
  world.appendChild(el); stops.push({i,x:p.x,y:p.y,el,badge,coord});
});

function refresh(){
  stops.forEach(n=>{
    n.el.classList.toggle('active', done.includes(n.i) || n.i===currentIndex);
    n.el.style.left=n.x+'%'; n.el.style.top=n.y+'%';
    n.coord.textContent=`${n.x.toFixed(1)}%, ${n.y.toFixed(1)}%`;
  });
}

function placeBoohaAt(i){ const n=stops[i]; const r=maze.getBoundingClientRect(); const x=r.left+(n.x/100)*r.width; const y=r.top+(n.y/100)*r.height; booha.style.left=x+'px'; booha.style.top=y+'px'; }

function spawnSpark(x,y,c){ const s=document.createElement('i'); s.className='spark'; s.style.color=c||'#ffd400'; s.style.left=x+'px'; s.style.top=y+'px'; document.body.appendChild(s); setTimeout(()=>s.remove(),720); }

function moveBooha(to){ return new Promise(resolve=>{ const from=stops[currentIndex]; const end=stops[to]; const r=maze.getBoundingClientRect(); const sx=r.left+(from.x/100)*r.width, sy=r.top+(from.y/100)*r.height; const ex=r.left+(end.x/100)*r.width, ey=r.top+(end.y/100)*r.height; const dur=1400; const t0=performance.now(); function step(t){ const k=Math.min(1,(t-t0)/dur); const e=k<.5?2*k*k:1-Math.pow(-2*k+2,2)/2; const x=sx+(ex-sx)*e, y=sy+(ey-sy)*e; booha.style.left=x+'px'; booha.style.top=y+'px'; if(Math.random()<.85) spawnSpark(x,y,'#ffd400'); if(k<1) requestAnimationFrame(step); else resolve(); } requestAnimationFrame(step); }); }

function zoomTo(i){ const n=stops[i]; const zoom=1.3; const rect=maze.getBoundingClientRect(); const cx=(n.x/100)*rect.width-rect.width/2; const cy=(n.y/100)*rect.height-rect.height/2; document.documentElement.style.setProperty('--zoom',zoom); document.documentElement.style.setProperty('--tx',(-cx*(zoom-1)/zoom)+'px'); document.documentElement.style.setProperty('--ty',(-cy*(zoom-1)/zoom)+'px'); }
function zoomReset(){ document.documentElement.style.setProperty('--zoom',1); document.documentElement.style.setProperty('--tx','0px'); document.documentElement.style.setProperty('--ty','0px'); }

function openWeek(i){ const m=Math.floor(i/4), w=(i%4)+1; titleEl.textContent=`${MONTHS[m]} — Week ${w}`; deck1.href=`placeholder.html?month=${MONTHS[m]}&week=${w}&deck=1`; deck2.href=`placeholder.html?month=${MONTHS[m]}&week=${w}&deck=2`; modal.classList.add('show'); }
modal.addEventListener('click',()=>{ modal.classList.remove('show'); zoomReset(); });

async function goTo(i){ await moveBooha(i); currentIndex=i; done.includes(i)||done.push(i); localStorage.setItem(LS_INDEX,String(currentIndex)); localStorage.setItem(LS_DONE,JSON.stringify(done)); refresh(); zoomTo(i); setTimeout(()=>openWeek(i), 450); }

stops.forEach((n,i)=>{ n.el.addEventListener('click',()=>{ if(document.body.classList.contains('editing')) return; goTo(i); }); });

// ---------- Edit mode (drag + save + copy JSON) ----------
let drag=null; editBtn.addEventListener('click',()=>{ document.body.classList.toggle('editing'); editBtn.textContent = document.body.classList.contains('editing')? 'EDIT ✓' : 'EDIT'; });
copyBtn.addEventListener('click',()=>{ const out=stops.map(s=>({x:+s.x.toFixed(2), y:+s.y.toFixed(2)})); navigator.clipboard.writeText(JSON.stringify(out)).then(()=>{copyBtn.textContent='Copied!'; setTimeout(()=>copyBtn.textContent='Copy JSON',1200);}); localStorage.setItem(LS_POS, JSON.stringify(out)); });
resetBtn.addEventListener('click',()=>{ if(confirm('Reset local progress?')){ currentIndex=0; done=[]; localStorage.setItem(LS_INDEX,'0'); localStorage.setItem(LS_DONE,'[]'); refresh(); placeBoohaAt(0); } });

stops.forEach(n=>{
  n.el.addEventListener('pointerdown',e=>{ if(!document.body.classList.contains('editing')) return; drag=n; n.el.setPointerCapture(e.pointerId); });
  n.el.addEventListener('pointermove',e=>{ if(drag!==n) return; const r=maze.getBoundingClientRect(); const x=((e.clientX - r.left)/r.width)*100; const y=((e.clientY - r.top)/r.height)*100; n.x=Math.max(0,Math.min(100,x)); n.y=Math.max(0,Math.min(100,y)); n.el.style.left=n.x+'%'; n.el.style.top=n.y+'%'; n.coord.textContent=`${n.x.toFixed(1)}%, ${n.y.toFixed(1)}%`; });
  n.el.addEventListener('pointerup',()=>{ if(drag!==n) return; drag=null; const out=stops.map(s=>({x:+s.x.toFixed(2), y:+s.y.toFixed(2)})); localStorage.setItem(LS_POS, JSON.stringify(out)); console.log('Saved positions:', out); });
});

// Init
refresh(); placeBoohaAt(currentIndex);
window.addEventListener('resize',()=>placeBoohaAt(currentIndex));
</script>
</body>
</html>
