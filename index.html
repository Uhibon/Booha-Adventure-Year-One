<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Booha Overworld v3 — Smooth Year Path</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Noto+Sans+JP:wght@500;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b1530;         /* deep navy */
  --ink:#eaf1ff;        /* text */
  --muted:#94a3b8;      /* slate */
  --aqua:#65e7ff;       /* completed */
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{font-family:system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", Helvetica, Arial; background:var(--bg); color:var(--ink)}
.header{padding:18px 14px 6px;text-align:center}
.header h1{font-family:Cinzel,serif;font-weight:900;letter-spacing:.4px;font-size:clamp(22px,3.6vw,34px)}
.header p{color:var(--muted);font-size:clamp(12px,2.4vw,14px)}

/* Map stage */
#stage{position:relative; height:calc(100dvh - 150px); max-width:1100px; margin:8px auto 0; border:1px solid #ffffff18; border-radius:20px; overflow:hidden; background:radial-gradient(1600px 700px at 50% 0%, #0f1b3e, #0b1530 40%, #0a1227)}
#svg{position:absolute; inset:0}

/* Month gradient underlay ribbon (soft) */
#path{fill:none; stroke-width:6; stroke-linecap:round; opacity:.22}
#pathGlow{fill:none; stroke-width:12; filter:url(#blur); opacity:.10}

/* Week nodes */
.node{position:absolute; width:26px; height:26px; border-radius:50%; transform:translate(-50%,-50%); cursor:pointer; border:0; outline:none}
.node.locked{background:radial-gradient(circle,#29365d 0%, #1c2847 65%, #17223e 100%); box-shadow:0 0 0 2px #0008 inset}
.node.next{animation:pulse 2.1s ease-in-out infinite}
.node.done{background:radial-gradient(circle, #c7fbff 0%, #65e7ff 60%, #2bd0ff 100%); box-shadow:0 0 0 2px #00141e inset, 0 0 16px #65e7ffbb, 0 0 34px #2bd0ff55}
@keyframes pulse{0%,100%{filter:brightness(1)}50%{filter:brightness(1.2)}}

/* Month labels */
.label{position:absolute; font-family:Cinzel,serif; font-size:12px; color:#cbd5ff; opacity:.85; transform:translate(-50%,-50%)}

/* Booha (top-down) */
#booha{position:absolute; width:34px; height:34px; border-radius:50%; transform:translate(-50%,-50%); z-index:10; background:radial-gradient(circle at 35% 35%, #fffef0 0%, #fff87a 40%, #ffd400 78%, #ffb300 100%); box-shadow:0 0 12px #ffd40099, 0 10px 28px #000a; animation:shimmer 4s ease-in-out infinite}
#booha::before, #booha::after{content:""; position:absolute; top:12px; width:6px; height:6px; border-radius:50%; background:#000}
#booha::before{left:10px} #booha::after{right:10px}
@keyframes shimmer{0%,100%{box-shadow:0 0 12px #ffd40066, 0 10px 28px #000a}50%{box-shadow:0 0 20px #ffd400cc, 0 10px 28px #000a}}
#shadow{position:absolute; width:42px; height:12px; background:radial-gradient(ellipse at center, #0009 0%, transparent 70%); transform:translate(-50%,-50%); filter:blur(2px); opacity:.6; z-index:5}

/* Sparkle trail */
.spark{position:absolute; width:6px; height:6px; border-radius:50%; pointer-events:none; background:radial-gradient(circle at 35% 35%, #fff, #ffe66d 60%, transparent 72%); box-shadow:0 0 10px #ffd400cc; animation:spark .7s ease-out forwards}
@keyframes spark{0%{transform:scale(.85);opacity:1}60%{transform:scale(1.1)}100%{transform:scale(.2) translateY(6px);opacity:0}}

/* Modal */
.modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:50}
.modal.show{display:flex}
.modal .backdrop{position:absolute; inset:0; background:#0008}
.modal .card{position:relative; width:min(680px,92vw); border-radius:18px; border:1px solid #ffffff22; padding:16px; background:linear-gradient(180deg,#101d42,#0b1530); box-shadow:0 20px 50px #000a}
.modal h2{font-family:Cinzel,serif; font-size:18px}
.modal p{color:#c7d2fe; margin:6px 0 12px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.btn{flex:1; text-align:center; padding:10px 12px; border-radius:14px; border:1px solid #ffffff26; background:#101a39; color:#e2e8f0; text-decoration:none; font-size:14px}
.btn:hover{background:#122045}
.btn.primary{border-color:#ffe06644; background:linear-gradient(180deg,#1a2550,#122045)}
.close{position:absolute; right:10px; top:10px; border:none; background:transparent; color:#cbd5e1; font-size:20px; cursor:pointer}

/* Footer + TEST */
.footer{padding:10px 12px; text-align:center; color:#9fb0d5; font-size:12px}
.footer a{color:#cfe0ff}
#test{position:fixed; right:14px; bottom:14px; z-index:60; padding:10px 14px; font-weight:700; border-radius:12px; border:1px solid #ffffff26; background:#122045; color:#e5edff; cursor:pointer}
#test:hover{background:#1a2b5e}

</style>
</head>
<body>
  <header class="header">
    <h1>Booha Overworld — The Year Flows</h1>
    <p>Guide Booha along a free‑flowing path from January to December. Progress saves on this device.</p>
  </header>

  <main id="stage">
    <svg id="svg" viewBox="0 0 1000 600" preserveAspectRatio="none" aria-hidden="true">
      <defs>
        <linearGradient id="yearGrad" x1="0%" y1="0%" x2="100%" y2="0%">
          <!-- stops are added by JS using monthly colors -->
        </linearGradient>
        <filter id="blur"><feGaussianBlur stdDeviation="6" /></filter>
      </defs>
      <path id="pathGlow" stroke="url(#yearGrad)" d="" />
      <path id="path" stroke="url(#yearGrad)" d="" />
    </svg>
    <!-- labels and nodes injected here -->
  </main>

  <div class="footer">Bryan's English School — Boo‑riculum Adventure • <a href="#" id="reset">reset progress</a></div>
  <button id="test" title="Auto-play the year">TEST</button>

  <div id="shadow"></div>
  <div id="booha" aria-hidden="true"></div>

  <!-- Modal -->
  <div class="modal" id="modal" aria-hidden="true">
    <div class="backdrop" id="backdrop"></div>
    <div class="card">
      <button class="close" id="close">×</button>
      <h2 id="title">Month — Week</h2>
      <p id="desc">Choose a deck to open. You can replace these URLs later.</p>
      <div class="row">
        <a class="btn primary" id="deck1" href="#">Deck 1 (placeholder)</a>
        <a class="btn" id="deck2" href="#">Deck 2 (placeholder)</a>
      </div>
    </div>
  </div>

<script>
// --------------------------------------
// CONFIG
// --------------------------------------
const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const MONTH_COLORS = [
  '#cddfff', '#ffb6c1', '#ffda8a', '#a7f5b1', '#7fdfff', '#ffe066', '#ff9edb', '#f8b54c', '#d6b3ff', '#ff9851', '#ffd6a1', '#fff4c7'
];
const ROWS = 12, COLS = 4; // 12 months, 4 weeks each
const TOTAL = ROWS * COLS; // 48 nodes

const LS_INDEX = 'booha_overworld_v3_index';
const LS_DONE  = 'booha_overworld_v3_done';
let currentIndex = parseInt(localStorage.getItem(LS_INDEX) || '0', 10);
let done = JSON.parse(localStorage.getItem(LS_DONE) || '[]');

// Elements
const stage = document.getElementById('stage');
const svg = document.getElementById('svg');
const pathEl = document.getElementById('path');
const pathGlowEl = document.getElementById('pathGlow');
const grad = document.getElementById('yearGrad');
const booha = document.getElementById('booha');
const shadow = document.getElementById('shadow');
const modal = document.getElementById('modal');
const backdrop = document.getElementById('backdrop');
const closeBtn = document.getElementById('close');
const titleEl = document.getElementById('title');
const deck1 = document.getElementById('deck1');
const deck2 = document.getElementById('deck2');
const resetBtn = document.getElementById('reset');
const testBtn = document.getElementById('test');

// --------------------------------------
// Build free‑flowing path (Bézier chain)
// --------------------------------------
function buildPath(){
  const W = 1000, H = 600; // svg viewBox
  // Seed control points for a gentle S‑curve river through the canvas.
  const pts = [
    [40, 40],   [200, 60],  [340, 80],  [480, 70],
    [620, 60],  [760, 90],  [900, 120], [860, 200],
    [720, 260], [560, 300], [420, 340], [300, 400],
    [200, 470], [120, 520], [80, 560],  [140, 580],
    [300, 560], [460, 520], [620, 480], [760, 420],
    [880, 360], [920, 300], [880, 240], [760, 180],
    [620, 160], [480, 180], [340, 220], [220, 260],
    [140, 320], [120, 380], [160, 440], [260, 500],
    [420, 540], [600, 530], [760, 500], [880, 460]
  ];
  // Convert to smooth cubic segments
  let d = `M ${pts[0][0]},${pts[0][1]}`;
  for(let i=1;i<pts.length-2;i+=2){
    const [c1x,c1y] = pts[i];
    const [c2x,c2y] = pts[i+1];
    const [ex,ey]   = pts[i+2];
    d += ` C ${c1x},${c1y} ${c2x},${c2y} ${ex},${ey}`;
  }
  pathEl.setAttribute('d', d);
  pathGlowEl.setAttribute('d', d);
  // Gradient stops for months
  grad.innerHTML = '';
  for(let m=0;m<12;m++){
    const start = (m/12)*100;
    const end   = ((m+1)/12)*100;
    const s = document.createElementNS('http://www.w3.org/2000/svg','stop');
    s.setAttribute('offset', start+'%'); s.setAttribute('stop-color', MONTH_COLORS[m]); grad.appendChild(s);
    const e = document.createElementNS('http://www.w3.org/2000/svg','stop');
    e.setAttribute('offset', end+'%'); e.setAttribute('stop-color', MONTH_COLORS[m]); grad.appendChild(e);
  }
}

buildPath();

// Compute node positions along path
const pathLen = pathEl.getTotalLength();
const nodes = []; // {i, monthIdx, weekIdx, x, y, el, color}
for(let i=0;i<TOTAL;i++){
  const t = (i+1) / (TOTAL+1); // spread along path, avoid extreme ends
  const pt = pathEl.getPointAtLength(t*pathLen);
  const monthIdx = Math.floor(i/4);
  const weekIdx = (i % 4) + 1;
  const color = MONTH_COLORS[monthIdx];
  // Create node
  const node = document.createElement('button');
  node.className = 'node locked';
  node.style.left = (pt.x / 10) + '%';
  node.style.top  = (pt.y / 6) + '%';
  node.title = `${MONTHS[monthIdx]} — Week ${weekIdx}`;
  stage.appendChild(node);
  nodes.push({i, monthIdx, weekIdx, x:pt.x, y:pt.y, el:node, color});
  // Month label only once per month, positioned slightly before first node of that month
  if(weekIdx===1){
    const lblPt = pathEl.getPointAtLength(((i+0.3)/(TOTAL+1))*pathLen);
    const label = document.createElement('div');
    label.className = 'label';
    label.textContent = MONTHS[monthIdx];
    label.style.left = (lblPt.x/10) + '%';
    label.style.top  = (lblPt.y/6 - 3) + '%';
    stage.appendChild(label);
  }
}

// Update node visual states
function refreshNodes(){
  nodes.forEach(n=>{
    n.el.className = 'node';
    if(done.includes(n.i)){
      n.el.classList.add('done');
    } else if(n.i === currentIndex){
      n.el.classList.add('next');
      // tint "next" using month color
      n.el.style.background = `radial-gradient(circle, ${n.color} 0%, ${n.color} 60%, ${shade(n.color,-20)} 100%)`;
      n.el.style.boxShadow  = `0 0 0 2px #0008 inset, 0 0 16px ${hexA(n.color, .65)}, 0 0 34px ${hexA(n.color, .35)}`;
    } else if(n.i < currentIndex){
      n.el.classList.add('done');
    } else {
      n.el.classList.add('locked');
      n.el.style.boxShadow = '0 0 0 2px #0008 inset';
    }
  });
}

function hexA(hex, a){
  // hex like #rrggbb
  const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${a})`;
}
function shade(hex, pct){
  const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
  const f = (v)=>Math.max(0, Math.min(255, Math.round(v*(100+pct)/100)));
  return `#${f(r).toString(16).padStart(2,'0')}${f(g).toString(16).padStart(2,'0')}${f(b).toString(16).padStart(2,'0')}`;
}

// Booha placement & movement
function placeBooha(i){
  const n = nodes[i] || nodes[0];
  const x = n.x, y = n.y; // svg coords
  const rect = stage.getBoundingClientRect();
  const bx = rect.left + (x/1000)*rect.width + window.scrollX;
  const by = rect.top  + (y/600)*rect.height + window.scrollY;
  booha.style.left = bx + 'px';
  booha.style.top  = by + 'px';
  shadow.style.left = bx + 'px';
  shadow.style.top  = (by + 18) + 'px';
}

function moveBooha(fromIdx, toIdx, {pauseMs=700}={}){
  return new Promise(resolve=>{
    const startLen = ((fromIdx+1)/(TOTAL+1))*pathLen;
    const endLen   = ((toIdx+1)/(TOTAL+1))*pathLen;
    const dist = Math.abs(endLen - startLen);
    const dur = Math.max(900, Math.min(2600, dist*1.0)); // dynamic duration based on distance
    const t0 = performance.now();
    const dir = endLen > startLen ? 1 : -1;

    function frame(t){
      const k = Math.min(1, (t - t0) / dur);
      const eased = k<.5 ? 2*k*k : 1 - Math.pow(-2*k+2, 2)/2; // easeInOutQuad
      const curLen = startLen + dir * dist * eased;
      const p = pathEl.getPointAtLength(curLen);
      const rect = stage.getBoundingClientRect();
      const bx = rect.left + (p.x/1000)*rect.width + window.scrollX;
      const by = rect.top  + (p.y/600)*rect.height + window.scrollY;
      // trail
      if(k>0){ spawnSpark(bx + (Math.random()*10-5), by + (Math.random()*10-5)); }
      booha.style.left = bx + 'px';
      booha.style.top  = by + 'px';
      shadow.style.left = bx + 'px';
      shadow.style.top  = (by + 18) + 'px';
      if(k<1) requestAnimationFrame(frame); else setTimeout(resolve, pauseMs);
    }
    requestAnimationFrame(frame);
  });
}

function spawnSpark(x,y,color){
  const s = document.createElement('i');
  s.className = 'spark';
  if(color) s.style.boxShadow = `0 0 10px ${hexA(color,.9)}`;
  s.style.left = x + 'px';
  s.style.top  = y + 'px';
  document.body.appendChild(s);
  setTimeout(()=>s.remove(), 720);
}

function burstAt(n){
  // Explode tiny particles in month color
  for(let i=0;i<10;i++){
    setTimeout(()=>{
      const rect = stage.getBoundingClientRect();
      const bx = rect.left + (n.x/1000)*rect.width + (Math.random()*40-20) + window.scrollX;
      const by = rect.top  + (n.y/600)*rect.height + (Math.random()*40-20) + window.scrollY;
      spawnSpark(bx, by, n.color);
    }, i*30);
  }
}

// Click handling: open modal only on current or completed nodes
nodes.forEach(n=>{
  n.el.addEventListener('click', ()=>{
    if(n.i > currentIndex) return; // future locked
    openWeek(n);
  });
});

function openWeek(n){
  titleEl.textContent = `${MONTHS[n.monthIdx]} — Week ${n.weekIdx}`;
  const qs = `?month=${MONTHS[n.monthIdx].toLowerCase()}&week=${n.weekIdx}`;
  deck1.href = `placeholder.html${qs}&deck=1`;
  deck2.href = `placeholder.html${qs}&deck=2`;
  modal.classList.add('show');

  const mark = ()=>{
    if(!done.includes(n.i)) done.push(n.i);
    localStorage.setItem(LS_DONE, JSON.stringify(done));
    if(currentIndex === n.i && currentIndex < TOTAL-1){
      currentIndex++;
      localStorage.setItem(LS_INDEX, String(currentIndex));
    }
    refreshNodes();
    modal.classList.remove('show');
  };
  deck1.onclick = mark; deck2.onclick = mark;
}

// Close modal
[backdrop, closeBtn].forEach(el=>el.addEventListener('click',()=>modal.classList.remove('show')));

// Reset
resetBtn.addEventListener('click', (e)=>{
  e.preventDefault();
  if(confirm('Reset local progress on this device?')){
    currentIndex = 0; done = [];
    localStorage.setItem(LS_INDEX,'0');
    localStorage.setItem(LS_DONE,'[]');
    refreshNodes();
    placeBooha(0);
  }
});

// TEST autoplay (smooth, with pauses and bursts)
let testing = false;
async function autoplay(){
  if(testing) return; testing = true; testBtn.textContent = 'RUNNING…';
  // start from currentIndex through end
  for(let i=currentIndex; i<TOTAL; i++){
    const n = nodes[i];
    // move to node i
    await moveBooha(i===0?0:i-1, i, {pauseMs:600});
    burstAt(n);
    // mark done visually (no modal during test)
    if(!done.includes(i)) done.push(i);
    localStorage.setItem(LS_DONE, JSON.stringify(done));
    currentIndex = Math.min(i+1, TOTAL-1);
    localStorage.setItem(LS_INDEX, String(currentIndex));
    refreshNodes();
  }
  testing = false; testBtn.textContent = 'TEST';
}

testBtn.addEventListener('click', autoplay);

// Init
refreshNodes();
placeBooha(currentIndex);

// Keep aligned on resize
window.addEventListener('resize', ()=>placeBooha(currentIndex));
</script>
</body>
</html>
