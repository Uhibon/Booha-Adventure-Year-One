<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Booha Maze — Year One (Deluxe 2)</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Noto+Sans+JP:wght@500;700&display=swap" rel="stylesheet" />
<style>
:root{ --zoom:1; --tx:0px; --ty:0px; }
*{box-sizing:border-box;margin:0;padding:0}
html,body{width:100%;height:100%;overflow:hidden}
body{background:radial-gradient(140% 100% at 50% 0%, #17381f 0%, #112a18 40%, #0c2012 85%, #08160c 100%);font-family:system-ui,"Noto Sans JP",sans-serif}

/* Fullscreen stage */
.viewport{position:relative;width:100vw;height:100vh;overflow:hidden}
.world{position:absolute;left:50%;top:50%;transform:translate(calc(-50% + var(--tx)), calc(-50% + var(--ty))) scale(var(--zoom));transform-origin:center;transition:transform .65s cubic-bezier(.22,.65,.2,1)}
#maze{width:100vw;height:100vh;background:url('assets/maze.png') center/contain no-repeat}

/* Booha (transparent PNG expected) */
#booha{position:absolute;width:68px;height:68px;transform:translate(-50%,-50%);z-index:12;pointer-events:none;image-rendering:auto;filter:drop-shadow(0 0 10px #ffe17a) drop-shadow(0 4px 18px #000a)}
@keyframes bob{0%,100%{transform:translate(-50%,-50%) translateY(0)}50%{transform:translate(-50%,-50%) translateY(-6px)}}
.bobbing{animation:bob 3.4s ease-in-out infinite}

/* GOLD sparkle trail (fine + denser) */
.spark{position:absolute;width:2.6px;height:2.6px;border-radius:50%;pointer-events:none;background:radial-gradient(circle at 40% 40%, #fff, #ffe07a 60%, transparent 72%);box-shadow:0 0 5px #ffd86d, 0 0 9px #ffec9c;opacity:0.95;animation:spark .6s ease-out forwards}
@keyframes spark{
  0%{transform:translate(0,0) scale(1);opacity:.95}
  60%{transform:translate(0,-4px) scale(1.12);opacity:.8}
  100%{transform:translate(0,9px) scale(.58);opacity:0}
}

/* FAIRY LIGHTS (month color, behind window) */
.fairy{position:absolute;width:2.2px;height:2.2px;border-radius:50%;pointer-events:none;box-shadow:0 0 8px currentColor, 0 0 14px currentColor;opacity:.96;transform:translate(-50%,-50%) scale(.82);animation:drift var(--dur,4800ms) ease-out forwards;z-index:20}
@keyframes drift{
  from{transform:translate(-50%,-50%) scale(.82);opacity:.96}
  to{transform:translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(1.06);opacity:0}
}

/* Weekly stops: invisible until revealed */
.stop{position:absolute;width:18px;height:18px;border-radius:50%;transform:translate(-50%,-50%);opacity:0;pointer-events:none;z-index:11}
.stop.hidden{opacity:0;transform:translate(-50%,-50%) scale(.6)}
.stop.seen{opacity:1;pointer-events:auto;animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{filter:brightness(1)}50%{filter:brightness(1.25)}}

/* Zoom vignette */
.viewport::after{content:"";position:absolute;inset:0;pointer-events:none;opacity:0;transition:opacity .35s ease;background:radial-gradient(120% 120% at 50% 50%, transparent 40%, #000 100%)}
.viewport.zoomed::after{opacity:.55}

/* Modal window (center card) */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#0008;z-index:120}
.modal.show{display:flex}
.card{
  width:min(760px,92vw);
  background:#0f1836;
  border:1px solid #ffffff26;
  box-shadow:0 25px 60px #000c, inset 0 0 0 1px #ffffff10;
  border-radius:18px;
  padding:22px;
  color:#fff;
  text-align:center;
  transform:scale(.92);
  opacity:0;
  animation:pop .45s cubic-bezier(.2,.8,.2,1) forwards;
}
@keyframes pop{to{transform:scale(1);opacity:1}}

.card .title-en{font-family:"Cinzel",serif;font-weight:900;letter-spacing:.5px;font-size:clamp(22px,3.2vw,30px);text-shadow:0 0 14px var(--glow, #9ad), 0 0 28px var(--glow, #9ad)}
.card .title-jp{font-family:"Noto Sans JP",sans-serif;margin-top:6px;font-weight:700;opacity:.9}
.placeholders{display:flex;gap:16px;justify-content:center;margin-top:18px}
.box{
  width:180px;height:120px;border-radius:16px;
  background:linear-gradient(145deg,#0e1531,#121e45);
  border:1px solid #ffffff22;
  box-shadow:0 0 18px var(--glow, #9ad), inset 0 0 0 1px #ffffff10;
  display:grid;place-items:center;
  font-family:"Cinzel",serif;font-weight:700;
}
.card .hint{opacity:.8;margin-top:12px;font-size:.95rem}

/* Controls */
.tools{position:fixed;left:12px;bottom:12px;display:flex;gap:8px;z-index:200}
.btn{padding:10px 14px;font-weight:700;border-radius:12px;border:1px solid #ffffff26;background:#203a27;color:#e5edff;cursor:pointer}
.btn:hover{background:#25452f}
</style>
</head>
<body>
<div class="viewport" id="viewport">
  <div class="world" id="world">
    <div id="maze"></div>
  </div>
</div>
<img id="booha" class="bobbing" src="assets/mazebooha.png" alt="booha" />

<!-- Controls -->
<div class="tools">
  <button class="btn" id="test">TEST</button>
  <button class="btn" id="next">Next ▶︎</button>
  <button class="btn" id="reset">Reset</button>
</div>

<!-- Window -->
<div class="modal" id="modal">
  <div class="card" id="card">
    <div class="title-en" id="title-en">January — Week 1</div>
    <div class="title-jp" id="title-jp">1月　第1週</div>
    <div class="placeholders">
      <div class="box">Deck 1</div>
      <div class="box">Deck 2</div>
    </div>
    <div class="hint">Tap <b>Next</b> to continue the adventure.</div>
  </div>
</div>

<script>
/* ------------------ CONFIG ------------------ */
const MONTHS_EN=['January','February','March','April','May','June','July','August','September','October','November','December'];
const MONTHS_JP=['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'];
const MONTH_COLORS=['#cddfff','#ffb6c1','#ffda8a','#a7f5b1','#7fdfff','#ffe066','#ff9edb','#f8b54c','#d6b3ff','#ff9851','#ffd6a1','#fff4c7'];
const GOLD='#ffd86d';
const TOTAL=48; // 4 per month

// Finalized coordinates:
const POS=[{"x":36.94,"y":4.85},{"x":32.14,"y":55.21},{"x":72.12,"y":69.2},{"x":53.92,"y":13.34},{"x":24.14,"y":82.86},{"x":63.67,"y":32.74},{"x":32.22,"y":26.27},{"x":65.27,"y":83.02},{"x":54.38,"y":59.66},{"x":70.22,"y":24.33},{"x":45.39,"y":13.58},{"x":22.77,"y":63.78},{"x":45.62,"y":41.47},{"x":40.14,"y":73.89},{"x":37.55,"y":13.26},{"x":71.67,"y":59.74},{"x":44.71,"y":26.35},{"x":32.22,"y":82.54},{"x":54.15,"y":22.88},{"x":24.68,"y":89.33},{"x":63.59,"y":41.63},{"x":64.51,"y":23.44},{"x":44.33,"y":55.21},{"x":71.21,"y":79.22},{"x":31.91,"y":37.91},{"x":59.1,"y":94.02},{"x":69.54,"y":50.53},{"x":33.28,"y":89.65},{"x":70.98,"y":35.41},{"x":22.92,"y":73.65},{"x":55.67,"y":51.01},{"x":37.32,"y":25.71},{"x":55.98,"y":73.89},{"x":54.91,"y":31.85},{"x":56.21,"y":82.54},{"x":31.68,"y":45.68},{"x":64.36,"y":59.18},{"x":39.22,"y":63.3},{"x":70.91,"y":42.36},{"x":32.75,"y":63.78},{"x":48.97,"y":63.78},{"x":43.03,"y":94.18},{"x":70.75,"y":30.07},{"x":61.08,"y":46.97},{"x":44.33,"y":82.46},{"x":53.47,"y":41.96},{"x":37.32,"y":19.73},{"x":65.73,"y":96.2}];

/* ---------------- Elements ---------------- */
const viewport=document.getElementById('viewport');
const world=document.getElementById('world');
const maze=document.getElementById('maze');
const booha=document.getElementById('booha');
const testBtn=document.getElementById('test');
const nextBtn=document.getElementById('next');
const resetBtn=document.getElementById('reset');
const modal=document.getElementById('modal');
const card=document.getElementById('card');
const titleEN=document.getElementById('title-en');
const titleJP=document.getElementById('title-jp');

/* ---------------- Audio ---------------- */
const bgm = new Audio('audio/sneaky.mp3'); bgm.loop = true;
const sfxCheckpoint = new Audio('audio/checkpoint.mp3'); // required
let audioPrimed = false;
function primeAudio(){ if(audioPrimed) return; audioPrimed=true; bgm.currentTime=0; bgm.play().catch(()=>{}); }

/* --------------- State ---------------- */
let currentIndex=0;
let revealed = Array(TOTAL).fill(false);
let moving=false;

/* ------------- Build stops ------------- */
const stops=[];
POS.forEach((p,i)=>{
  const el=document.createElement('div');
  el.className='stop hidden';
  el.style.left=p.x+'%'; el.style.top=p.y+'%';
  world.appendChild(el);
  stops.push({i,x:p.x,y:p.y,el});
});

/* -------------- Helpers --------------- */
function monthColor(i){return MONTH_COLORS[Math.floor(i/4)];}
function weekOf(i){return (i%4)+1;}
function monthOf(i){return Math.floor(i/4);}

function styleStop(i){
  const n=stops[i]; const color=monthColor(i);
  n.el.style.background = `radial-gradient(circle, ${color} 0%, ${color} 60%, ${shade(color,-20)} 100%)`;
  n.el.style.boxShadow = `0 0 0 2px #0008 inset, 0 0 16px ${hexA(color,.65)}, 0 0 34px ${hexA(color,.35)}`;
}

function revealStop(i){
  if(revealed[i]) return; revealed[i]=true; styleStop(i);
  const el=stops[i].el; el.classList.remove('hidden'); el.classList.add('seen');
}

/* pixel-placing helpers (exact center) */
function stopPx(i){
  const n=stops[i]; const r=maze.getBoundingClientRect();
  const x=r.left+(n.x/100)*r.width + window.scrollX;
  const y=r.top +(n.y/100)*r.height + window.scrollY;
  return {x,y};
}
function placeBoohaAt(i){
  const {x,y}=stopPx(i);
  booha.style.left=x+'px'; booha.style.top=y+'px';
}

/* --------- Movement (much slower + exact stop) --------- */
function moveBooha(to){
  return new Promise(resolve=>{
    moving=true;
    const r=maze.getBoundingClientRect();
    const from = stopPx(currentIndex);
    const end  = stopPx(to);

    const sx=from.x, sy=from.y, ex=end.x, ey=end.y;
    const dist=Math.hypot(ex-sx,ey-sy);

    // MUCH slower glide:
    const dur = Math.max(3500, Math.min(9000, dist * 4.0)); // ~50% speed of last build

    const t0=performance.now();
    function step(t){
      const k=Math.min(1,(t-t0)/dur);
      const e=k<.5?2*k*k:1-Math.pow(-2*k+2,2)/2;
      const x=sx+(ex-sx)*e, y=sy+(ey-sy)*e;
      booha.style.left=x+'px'; booha.style.top=y+'px';

      // GOLD trail — fine + denser
      if(Math.random()<.97){
        for(let n=0;n<(Math.random()<.45?2:1);n++) spawnSpark(x+(Math.random()*5-2.5), y+(Math.random()*5-2.5));
      }

      if(k<1) requestAnimationFrame(step); 
      else {
        // snap exactly to the stop
        placeBoohaAt(to);
        moving=false; 
        resolve();
      }
    }
    requestAnimationFrame(step);
  });
}

/* -------- Visual effects -------- */
function spawnSpark(x,y){
  const s=document.createElement('i'); s.className='spark'; s.style.left=x+'px'; s.style.top=y+'px';
  document.body.appendChild(s); setTimeout(()=>s.remove(),620);
}

function fairyBurst(i){
  const {x:cx,y:cy}=stopPx(i);
  const color=monthColor(i);

  const count = 150;            // more fairy lights
  const radiusMin = 36;
  const radiusMax = 180;        // further flow
  for(let n=0;n<count;n++){
    const a = Math.random()*Math.PI*2;
    const len = radiusMin + Math.random()*(radiusMax-radiusMin);
    const dx = Math.cos(a)*len;
    const dy = Math.sin(a)*len;

    const tw = document.createElement('i');
    tw.className='fairy';
    tw.style.color = color;
    tw.style.left = cx+'px';
    tw.style.top  = cy+'px';
    tw.style.setProperty('--dx', dx+'px');
    tw.style.setProperty('--dy', dy+'px');
    tw.style.setProperty('--dur', (4000+Math.random()*3000)+'ms'); // 4–7s
    // Add tiny start delay to create waves
    tw.style.animationDelay = (Math.random()*300)+'ms';
    document.body.appendChild(tw);
    setTimeout(()=>tw.remove(), 7600);
  }
}

/* ---------- Zoom helpers ---------- */
function zoomTo(i){
  const n=stops[i]; const zoom=1.28; const rect=maze.getBoundingClientRect();
  const cx=(n.x/100)*rect.width - rect.width/2; 
  const cy=(n.y/100)*rect.height - rect.height/2;
  document.documentElement.style.setProperty('--zoom', zoom);
  document.documentElement.style.setProperty('--tx', (-cx*(zoom-1)/zoom)+'px');
  document.documentElement.style.setProperty('--ty', (-cy*(zoom-1)/zoom)+'px');
  viewport.classList.add('zoomed');
}
function zoomReset(){ 
  document.documentElement.style.setProperty('--zoom',1); 
  document.documentElement.style.setProperty('--tx','0px'); 
  document.documentElement.style.setProperty('--ty','0px'); 
  viewport.classList.remove('zoomed'); 
}

/* ---------------- Window ---------------- */
function setWindowTitles(i){
  const m = monthOf(i);
  const w = weekOf(i);
  const color = monthColor(i);
  titleEN.textContent = `${MONTHS_EN[m]} — Week ${w}`;
  titleJP.textContent = `${MONTHS_JP[m]}　　第${w}週`;
  card.style.setProperty('--glow', color);
}
function openWindow(){ modal.classList.add('show'); card.style.animation='none'; void card.offsetWidth; card.style.animation=null; } // replay pop
function closeWindow(){ modal.classList.remove('show'); }

/* ----- Audio gating: wait for SFX + at least 4s ----- */
function playAndGateCheckpoint(){
  return new Promise(resolve=>{
    const started = performance.now();
    let done = false;

    const finish = ()=>{
      if(done) return; done=true;
      const elapsed = performance.now() - started;
      const remain = Math.max(0, 4000 - elapsed); // ensure >=4s total
      setTimeout(resolve, remain);
    };

    sfxCheckpoint.currentTime = 0;
    const onEnd = ()=>{ sfxCheckpoint.removeEventListener('ended', onEnd); finish(); };
    sfxCheckpoint.addEventListener('ended', onEnd);
    sfxCheckpoint.play().catch(()=>{ // fallback if blocked
      setTimeout(finish, 4000);
    });

    // absolute safety timeout (if metadata missing)
    setTimeout(finish, 7000);
  });
}

/* -------- Arrival behavior -------- */
async function arriveAt(i){
  revealStop(i);
  fairyBurst(i);          // month-colored fairy lights (continue behind window)
  zoomTo(i);              // zoom in and STAY
  setWindowTitles(i);     // set EN/JP titles + glow color
  await playAndGateCheckpoint();   // wait for checkpoint.mp3 + >=4s
  openWindow();
}

/* ---------------- Controls ---------------- */
resetBtn.addEventListener('click',()=>{
  primeAudio();
  currentIndex=0; 
  revealed=Array(TOTAL).fill(false); 
  document.querySelectorAll('.stop').forEach(s=>s.className='stop hidden'); 
  placeBoohaAt(0); 
  closeWindow(); 
  zoomReset();
});

testBtn.addEventListener('click',()=>{
  primeAudio();
  currentIndex=0; 
  revealed=Array(TOTAL).fill(false);
  document.querySelectorAll('.stop').forEach(s=>s.className='stop hidden');
  placeBoohaAt(0);
  arriveAt(0);
});

nextBtn.addEventListener('click', async ()=>{
  primeAudio();
  if(moving) return;
  closeWindow();      // close window, then move
  zoomReset();
  let next = currentIndex + 1;
  if(next >= TOTAL) next = 0; // wrap
  await moveBooha(next);
  currentIndex = next;
  await arriveAt(currentIndex);
});

/* --------------- Init ---------------- */
placeBoohaAt(0);
window.addEventListener('resize',()=>placeBoohaAt(currentIndex));

/* ---------------- Utils ---------------- */
function hexA(hex,a){const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return `rgba(${r},${g},${b},${a})`;}
function shade(hex,p){const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);const f=v=>Math.max(0,Math.min(255,Math.round(v*(100+p)/100)));return `#${f(r).toString(16).padStart(2,'0')}${f(g).toString(16).padStart(2,'0')}${f(b).toString(16,'0')}`;}
</script>
</body>
</html>
